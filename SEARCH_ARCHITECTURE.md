# Enhanced Search System Architecture
# å¢å¼·æœå°‹ç³»çµ±æ¶æ§‹èªªæ˜

æœ¬æ–‡ä»¶æä¾›å¢å¼·æœå°‹ç³»çµ±çš„å®Œæ•´æ¶æ§‹èªªæ˜ï¼ŒåŒ…å«çµ„ä»¶é—œä¿‚ã€è³‡æ–™æµã€èˆ‡ Callback æµç¨‹ã€‚

---

## ç³»çµ±æ¶æ§‹æ¦‚è¦½

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Enhanced Search System                       â”‚
â”‚                      å¢å¼·æœå°‹ç³»çµ±                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                â”‚                â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
         â”‚   UI Layer   â”‚  â”‚ Logic Layer  â”‚ â”‚  Data Layer  â”‚
         â”‚   ä»‹é¢å±¤      â”‚  â”‚  é‚è¼¯å±¤       â”‚ â”‚   è³‡æ–™å±¤     â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 1. UI Layer (ä»‹é¢å±¤)

### 1.1 ä¸»æœå°‹æ¬„ (Main Search Bar)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [ğŸ”] Search Input   [ğŸ´] Cuisine   [â­] Rating  [âš™ï¸] Filters â”‚
â”‚                                                      [Search] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**çµ„ä»¶æ§‹æˆ**:
- `search-destination` (dcc.Input): é—œéµå­—è¼¸å…¥æ¡†
- `search-cuisine` (dcc.Dropdown): æ–™ç†é¡å‹é¸æ“‡å™¨
- `search-rating` (dcc.Dropdown): è©•åˆ†ç¯©é¸å™¨
- `toggle-advanced-filters` (Button): é€²éšç¯©é¸æŒ‰éˆ•
- `search-btn` (Button): æœå°‹æŒ‰éˆ•
- `clear-search-btn` (Button): æ¸…é™¤æŒ‰éˆ•

### 1.2 æœå°‹å»ºè­°æ¡† (Search Suggestions)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸª Sushi Kyoto                          â”‚  â† Restaurant
â”‚     Japanese Â· Kyoto Station             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ´ Sushi                                â”‚  â† Cuisine
â”‚     42 restaurants                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ“ Kyoto Station                        â”‚  â† Location
â”‚     156 restaurants                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ•¸æ“šçµæ§‹**:
```python
{
    'text': 'é¡¯ç¤ºæ–‡å­—',
    'category': 'é¡åˆ¥èªªæ˜',
    'icon': 'fa-icon',
    'type': 'restaurant|cuisine|station',
    'value': 'å¯¦éš›å€¼'
}
```

### 1.3 é€²éšç¯©é¸å™¨ (Advanced Filters)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ’´ Price Range              ğŸ“ Location / Station        â”‚
â”‚  â˜ Budget (Â¥1000-Â¥1999)      [Dropdown: Multiple Select] â”‚
â”‚  â˜ Mid-range (Â¥2000-Â¥3999)                               â”‚
â”‚  â˜ Fine Dining (Â¥4000+)                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ’¬ Minimum Reviews          ğŸ”„ Sort By                   â”‚
â”‚  [â”€â”€â”€â”€â—â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€] 50+     âšª Rating (High to Low)      â”‚
â”‚   0    50   100  150  200    âšª Rating (Low to High)      â”‚
â”‚                              âšª Review Count               â”‚
â”‚                              âšª Name (A-Z)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.4 ç¯©é¸æ¨™ç±¤ (Filter Chips)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [Cuisine: Sushi âœ•] [Rating: â­â­â­â­+ âœ•] [Budget âœ•]  â”‚
â”‚  [Location: Kyoto âœ•] [Min Reviews: 50+ âœ•]           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**äº’å‹•è¡Œç‚º**:
- é»æ“Š `âœ•` â†’ ç§»é™¤è©²ç¯©é¸æ¢ä»¶
- è‡ªå‹•æ›´æ–°æœå°‹çµæœ

### 1.5 æœå°‹æ­·å²èˆ‡ç†±é–€ (History & Popular)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“œ Recent Searches   â”‚  ğŸ”¥ Popular Searches  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ” sushi (5m ago)    â”‚  Sushi (42 searches)  â”‚
â”‚  ğŸ” ramen (15m ago)   â”‚  Ramen (38 searches)  â”‚
â”‚  ğŸ” kaiseki (1h ago)  â”‚  Kyoto (35 searches)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. Logic Layer (é‚è¼¯å±¤)

### 2.1 æœå°‹é‚è¼¯æµç¨‹

```
ä½¿ç”¨è€…è¼¸å…¥é—œéµå­— "sushi"
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Keyword Search               â”‚
â”‚   - Name contains "sushi"       â”‚
â”‚   - JapaneseName contains       â”‚
â”‚   - FirstCategory contains      â”‚
â”‚   - SecondCategory contains     â”‚
â”‚   - Station contains            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Cuisine Filter               â”‚
â”‚   - FirstCategory == selected   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Rating Filter                â”‚
â”‚   - TotalRating >= selected     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. Advanced Filters             â”‚
â”‚   - Price Range                 â”‚
â”‚   - Stations                    â”‚
â”‚   - Min Reviews                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. Sort Results                 â”‚
â”‚   - By Rating/Reviews/Name      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
è¿”å›æœå°‹çµæœ (DataFrame)
```

### 2.2 åƒ¹æ ¼ç¯©é¸é‚è¼¯

```python
def get_price_category(price_str):
    """
    åƒ¹æ ¼å­—ä¸²ç¯„ä¾‹: "Â¥2000~Â¥2999"

    åˆ†é¡é‚è¼¯:
    - Budget: Â¥1000-Â¥1999
    - Mid-range: Â¥2000-Â¥3999
    - Fine Dining: Â¥4000+
    """
    if 'Â¥1000' in price_str or 'Â¥1999' in price_str:
        return 'budget'
    elif 'Â¥2000' in price_str or 'Â¥3000' in price_str:
        return 'mid'
    elif 'Â¥4000' in price_str or 'Â¥5000' in price_str:
        return 'high'
    return None
```

### 2.3 å»ºè­°ç”Ÿæˆé‚è¼¯

```
é—œéµå­—: "sush"
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: æœå°‹é¤å»³åç¨±                â”‚
â”‚   - Name contains "sush"           â”‚
â”‚   â†’ [Sushi Kyoto, Sushi Bar ...]  â”‚
â”‚   â†’ å–å‰ 3 å€‹                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 2: æœå°‹æ–™ç†é¡å‹                â”‚
â”‚   - FirstCategory contains "sush"  â”‚
â”‚   â†’ [Sushi]                        â”‚
â”‚   â†’ å–å‰ 3 å€‹                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 3: æœå°‹åœ°é»                    â”‚
â”‚   - Station contains "sush"        â”‚
â”‚   â†’ []  (æ²’æœ‰åŒ¹é…)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
åˆä½µä¸¦è¿”å›æœ€å¤š 8 å€‹å»ºè­°
```

---

## 3. Data Layer (è³‡æ–™å±¤)

### 3.1 dcc.Store è³‡æ–™æµ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     dcc.Store Components                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â”œâ”€â†’ search-history-store (session)
    â”‚   â””â”€ å„²å­˜æœ€è¿‘ 10 æ¬¡æœå°‹
    â”‚      - query: é—œéµå­—
    â”‚      - filters: ç¯©é¸å™¨è¨­å®š
    â”‚      - timestamp: æ™‚é–“æˆ³è¨˜
    â”‚
    â”œâ”€â†’ search-suggestions-store (memory)
    â”‚   â””â”€ æš«å­˜å³æ™‚å»ºè­°
    â”‚      - text, category, icon, type, value
    â”‚
    â”œâ”€â†’ active-filters-store (memory)
    â”‚   â””â”€ ç•¶å‰æ´»èºçš„ç¯©é¸å™¨
    â”‚      - keyword, cuisine, rating, price, stations, etc.
    â”‚
    â”œâ”€â†’ popular-searches-store (local)
    â”‚   â””â”€ ç†±é–€æœå°‹çµ±è¨ˆï¼ˆé•·æœŸä¿å­˜ï¼‰
    â”‚      - 'query:term': {term, type, count}
    â”‚      - 'cuisine:term': {term, type, count}
    â”‚      - 'station:term': {term, type, count}
    â”‚
    â”œâ”€â†’ search-results-store (memory)
    â”‚   â””â”€ æœå°‹çµæœï¼ˆDataFrame â†’ dict recordsï¼‰
    â”‚      - [{'Name': ..., 'TotalRating': ..., ...}, ...]
    â”‚
    â”œâ”€â†’ search-trigger (memory)
    â”‚   â””â”€ è§¸ç™¼æœå°‹çš„ä¿¡è™Ÿ
    â”‚      - timestamp (ç”¨æ–¼å³æ™‚æœå°‹)
    â”‚
    â””â”€â†’ filters-open-state (memory)
        â””â”€ é€²éšç¯©é¸å™¨é–‹é—œç‹€æ…‹
           - True / False
```

### 3.2 è³‡æ–™æŒä¹…åŒ–ç­–ç•¥

| Store | Storage Type | æ¸…é™¤æ™‚æ©Ÿ | ç”¨é€” |
|-------|-------------|---------|------|
| `search-history-store` | session | é—œé–‰ç€è¦½å™¨ | å–®æ¬¡æœƒè©±çš„æœå°‹è¨˜éŒ„ |
| `popular-searches-store` | local | æ‰‹å‹•æ¸…é™¤ | é•·æœŸçµ±è¨ˆç†±é–€æœå°‹ |
| `search-results-store` | memory | é é¢åˆ·æ–° | ç•¶å‰æœå°‹çµæœ |
| `search-suggestions-store` | memory | é é¢åˆ·æ–° | å³æ™‚å»ºè­°æš«å­˜ |
| `active-filters-store` | memory | é é¢åˆ·æ–° | ç•¶å‰ç¯©é¸ç‹€æ…‹ |

---

## 4. Callback Flow (å›èª¿æµç¨‹)

### 4.1 å®Œæ•´æœå°‹æµç¨‹

```
ä½¿ç”¨è€…é»æ“Š [Search] æŒ‰éˆ•
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  handle_comprehensive_search            â”‚
â”‚  (Callback #7)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Inputs:                                â”‚
â”‚    - search-btn.n_clicks                â”‚
â”‚    - search-trigger.data (å³æ™‚æœå°‹)      â”‚
â”‚                                         â”‚
â”‚  States:                                â”‚
â”‚    - search-destination.value           â”‚
â”‚    - search-cuisine.value               â”‚
â”‚    - search-rating.value                â”‚
â”‚    - price-filter.value                 â”‚
â”‚    - station-filter.value               â”‚
â”‚    - review-count-filter.value          â”‚
â”‚    - sort-by.value                      â”‚
â”‚    - search-history-store.data          â”‚
â”‚    - popular-searches-store.data        â”‚
â”‚                                         â”‚
â”‚  Outputs:                               â”‚
â”‚    - search-results-store.data          â”‚
â”‚    - current-page-store.data            â”‚
â”‚    - search-params-store.data           â”‚
â”‚    - search-history-store.data          â”‚
â”‚    - popular-searches-store.data        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â”œâ”€â†’ åŸ·è¡Œæœå°‹é‚è¼¯
    â”‚   â””â”€ æ‡‰ç”¨æ‰€æœ‰ç¯©é¸å™¨
    â”‚
    â”œâ”€â†’ æ›´æ–°æœå°‹æ­·å²
    â”‚   â””â”€ add_to_search_history()
    â”‚
    â”œâ”€â†’ æ›´æ–°ç†±é–€æœå°‹
    â”‚   â””â”€ update_popular_searches()
    â”‚
    â””â”€â†’ è¿”å›çµæœ
```

### 4.2 å³æ™‚å»ºè­°æµç¨‹

```
ä½¿ç”¨è€…è¼¸å…¥ "su"
    â”‚  (debounce 300ms)
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  update_search_suggestions              â”‚
â”‚  (Callback #1)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Input:                                 â”‚
â”‚    - search-destination.value           â”‚
â”‚                                         â”‚
â”‚  Outputs:                               â”‚
â”‚    - search-suggestions.children        â”‚
â”‚    - search-suggestions.style           â”‚
â”‚    - clear-search-btn.style             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â”œâ”€â†’ æª¢æŸ¥é—œéµå­—é•·åº¦ (>= 2)
    â”‚
    â”œâ”€â†’ generate_search_suggestions()
    â”‚   â”œâ”€ æœå°‹é¤å»³åç¨± (max 3)
    â”‚   â”œâ”€ æœå°‹æ–™ç†é¡å‹ (max 3)
    â”‚   â””â”€ æœå°‹è»Šç«™åœ°é» (max 2)
    â”‚
    â””â”€â†’ å‰µå»ºå»ºè­°çµ„ä»¶
        â””â”€ create_suggestion_item() Ã— N
```

### 4.3 ç¯©é¸æ¨™ç±¤æ›´æ–°æµç¨‹

```
ä½¿ç”¨è€…é¸æ“‡æ–™ç†é¡å‹ "Sushi"
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  update_filter_chips                    â”‚
â”‚  (Callback #5)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Inputs:                                â”‚
â”‚    - search-cuisine.value               â”‚
â”‚    - search-rating.value                â”‚
â”‚    - price-filter.value                 â”‚
â”‚    - station-filter.value               â”‚
â”‚    - review-count-filter.value          â”‚
â”‚                                         â”‚
â”‚  Output:                                â”‚
â”‚    - active-filters-chips.children      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â”œâ”€â†’ æ”¶é›†æ‰€æœ‰æ´»èºçš„ç¯©é¸å™¨
    â”‚
    â””â”€â†’ ç‚ºæ¯å€‹ç¯©é¸å™¨å‰µå»ºæ¨™ç±¤
        â””â”€ create_filter_chip() Ã— N
            â””â”€ åŒ…å«ç§»é™¤æŒ‰éˆ• (Pattern Matching ID)
```

### 4.4 ç§»é™¤ç¯©é¸æ¨™ç±¤æµç¨‹

```
ä½¿ç”¨è€…é»æ“Š [Cuisine: Sushi âœ•]
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  remove_filter_chip                     â”‚
â”‚  (Callback #6 - Pattern Matching)      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Input:                                 â”‚
â”‚    - {'type': 'remove-filter',          â”‚
â”‚       'filter': ALL,                    â”‚
â”‚       'value': ALL}.n_clicks            â”‚
â”‚                                         â”‚
â”‚  States:                                â”‚
â”‚    - All filter values                  â”‚
â”‚                                         â”‚
â”‚  Outputs:                               â”‚
â”‚    - Update corresponding filter        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â”œâ”€â†’ è§£æè¢«é»æ“Šçš„æ¨™ç±¤
    â”‚   â””â”€ button_data['filter'] â†’ 'cuisine'
    â”‚   â””â”€ button_data['value'] â†’ 'Sushi'
    â”‚
    â”œâ”€â†’ ç§»é™¤å°æ‡‰çš„ç¯©é¸å™¨å€¼
    â”‚   â””â”€ cuisine â†’ None
    â”‚
    â””â”€â†’ è§¸ç™¼ update_filter_chips
        â””â”€ é‡æ–°ç”Ÿæˆæ¨™ç±¤åˆ—è¡¨
```

### 4.5 æœå°‹æ­·å²é‡æ’­æµç¨‹

```
ä½¿ç”¨è€…é»æ“Šæ­·å²é …ç›® "sushi"
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  replay_history_search                  â”‚
â”‚  (Callback #10 - Pattern Matching)     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Input:                                 â”‚
â”‚    - {'type': 'history-item',           â”‚
â”‚       'query': ALL}.n_clicks            â”‚
â”‚                                         â”‚
â”‚  Outputs:                               â”‚
â”‚    - search-destination.value           â”‚
â”‚    - search-trigger.data                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â”œâ”€â†’ è§£ææ­·å²é …ç›®
    â”‚   â””â”€ query â†’ "sushi"
    â”‚
    â”œâ”€â†’ å¡«å…¥æœå°‹æ¡†
    â”‚   â””â”€ search-destination â†’ "sushi"
    â”‚
    â””â”€â†’ è§¸ç™¼æœå°‹
        â””â”€ search-trigger â†’ timestamp
            â””â”€ è§¸ç™¼ handle_comprehensive_search
```

---

## 5. æ•ˆèƒ½å„ªåŒ–ç­–ç•¥

### 5.1 é˜²æŠ–å‹• (Debouncing)

```python
dcc.Input(
    id='search-destination',
    debounce=300,  # 300ms å»¶é²
    ...
)
```

**æ•ˆæœ**:
- ä½¿ç”¨è€…å¿«é€Ÿè¼¸å…¥æ™‚ï¼Œä¸æœƒé »ç¹è§¸ç™¼ callback
- åªåœ¨åœæ­¢è¼¸å…¥ 300ms å¾Œæ‰åŸ·è¡Œ

### 5.2 æ¢ä»¶æ›´æ–° (Conditional Updates)

```python
@app.callback(...)
def some_callback(...):
    if not condition:
        raise PreventUpdate  # ä¸æ›´æ–°ä»»ä½• Output

    # æˆ–ä½¿ç”¨ no_update
    return no_update, no_update, valid_value
```

### 5.3 Pattern Matching Callbacks

```python
# å–®ä¸€ callback è™•ç†å¤šå€‹å‹•æ…‹ç”Ÿæˆçš„çµ„ä»¶
@app.callback(
    Output(...),
    [Input({'type': 'remove-filter', 'filter': ALL, 'value': ALL}, 'n_clicks')]
)
def handle_all_chips(n_clicks_list):
    # è‡ªå‹•è™•ç†æ‰€æœ‰ç¬¦åˆ pattern çš„çµ„ä»¶
    ...
```

**å„ªé»**:
- ä¸éœ€ç‚ºæ¯å€‹ç¯©é¸æ¨™ç±¤å¯«ä¸€å€‹ callback
- å‹•æ…‹ç”Ÿæˆçš„çµ„ä»¶è‡ªå‹•é©é…

### 5.4 çµæœå¿«å– (Caching)

```python
from functools import lru_cache

@lru_cache(maxsize=100)
def generate_suggestions_cached(keyword, df_id):
    # df_id = hash(restaurants_df)
    return generate_search_suggestions(keyword, restaurants_df)
```

### 5.5 åˆ†é è¼‰å…¥ (Pagination)

```python
# ä¸ä¸€æ¬¡è¿”å›æ‰€æœ‰çµæœ
items_per_page = 15
current_items = search_results[start_idx:end_idx]
```

---

## 6. éŒ¯èª¤è™•ç†èˆ‡å®¹éŒ¯

### 6.1 ç©ºå€¼è™•ç†

```python
# é—œéµå­—æœå°‹
if keyword:
    mask = df['Name'].str.contains(keyword, na=False)  # na=False é¿å… NaN éŒ¯èª¤
```

### 6.2 é¡å‹æª¢æŸ¥

```python
# ç¢ºä¿è³‡æ–™é¡å‹æ­£ç¢º
if not isinstance(price_filters, list):
    price_filters = []
```

### 6.3 ç•°å¸¸æ•ç²

```python
try:
    dt = datetime.strptime(timestamp, '%Y-%m-%d %H:%M:%S')
    time_str = format_relative_time(dt)
except:
    time_str = 'Recently'  # é è¨­å€¼
```

### 6.4 é è¨­å€¼æä¾›

```python
# ç†±é–€æœå°‹æ²’æœ‰è³‡æ–™æ™‚é¡¯ç¤ºé è¨­
if not popular_dict:
    return default_popular_items
```

---

## 7. å®‰å…¨æ€§è€ƒé‡

### 7.1 è¼¸å…¥é©—è­‰

```python
# é˜²æ­¢æƒ¡æ„è¼¸å…¥
if keyword and len(keyword) > 100:
    keyword = keyword[:100]  # æˆªæ–·éé•·è¼¸å…¥
```

### 7.2 SQL æ³¨å…¥é˜²è­·

```python
# ä½¿ç”¨ pandas å…§å»ºæ–¹æ³•ï¼Œä¸ç›´æ¥æ‹¼æ¥ SQL
filtered_df = df[df['Name'].str.contains(keyword, na=False)]
# è€Œé: df.query(f"Name LIKE '%{keyword}%'")  # å±éšª!
```

### 7.3 XSS é˜²è­·

```python
# Dash è‡ªå‹• escape HTML ç‰¹æ®Šå­—å…ƒ
html.Div(user_input)  # å®‰å…¨
# é¿å…ä½¿ç”¨ dangerously_allow_html
```

---

## 8. æ¸¬è©¦ç­–ç•¥

### 8.1 å–®å…ƒæ¸¬è©¦

```python
def test_generate_suggestions():
    df = pd.DataFrame({'Name': ['Sushi A', 'Ramen B']})
    suggestions = generate_search_suggestions('sushi', df)
    assert len(suggestions) > 0
    assert suggestions[0]['type'] == 'restaurant'
```

### 8.2 æ•´åˆæ¸¬è©¦

```python
def test_search_flow(dash_duo):
    dash_duo.start_server(app)
    dash_duo.wait_for_element('#search-destination')
    dash_duo.find_element('#search-destination').send_keys('sushi')
    dash_duo.wait_for_element('.suggestion-item')
    # ... é©—è­‰å»ºè­°é¡¯ç¤º
```

### 8.3 æ•ˆèƒ½æ¸¬è©¦

```python
import time

start = time.time()
result = search_restaurants(keyword='test', ...)
end = time.time()

assert end - start < 1.0  # æœå°‹æ‡‰åœ¨ 1 ç§’å…§å®Œæˆ
```

---

## 9. æ“´å±•æ€§è¨­è¨ˆ

### 9.1 å¤šèªè¨€æ”¯æ´

```python
TRANSLATIONS = {
    'en': {'search': 'Search', 'cuisine': 'Cuisine'},
    'ja': {'search': 'æ¤œç´¢', 'cuisine': 'æ–™ç†'},
    'zh': {'search': 'æœå°‹', 'cuisine': 'æ–™ç†'}
}

def get_text(key, lang='en'):
    return TRANSLATIONS[lang].get(key, key)
```

### 9.2 è‡ªè¨‚æ’åºæ¼”ç®—æ³•

```python
def custom_sort(df, sort_config):
    """
    æ”¯æ´è¤‡é›œçš„æ’åºé‚è¼¯

    sort_config = {
        'primary': ('TotalRating', False),  # (column, ascending)
        'secondary': ('ReviewNum', False),
        'weights': {'TotalRating': 0.7, 'ReviewNum': 0.3}
    }
    """
    # å¯¦ä½œåŠ æ¬Šæ’åº
    ...
```

### 9.3 æ’ä»¶åŒ–ç¯©é¸å™¨

```python
class FilterPlugin:
    def apply(self, df, params):
        raise NotImplementedError

class PriceFilterPlugin(FilterPlugin):
    def apply(self, df, params):
        return df[df['Price'].between(params['min'], params['max'])]

# è¨»å†Šæ’ä»¶
FILTER_PLUGINS = {
    'price': PriceFilterPlugin(),
    'distance': DistanceFilterPlugin(),
    ...
}
```

---

## 10. ç›£æ§èˆ‡åˆ†æ

### 10.1 æœå°‹åˆ†æ

```python
# è¨˜éŒ„æœå°‹äº‹ä»¶
def log_search(keyword, filters, result_count, user_id):
    analytics_db.insert({
        'timestamp': datetime.now(),
        'keyword': keyword,
        'filters': json.dumps(filters),
        'result_count': result_count,
        'user_id': user_id
    })
```

### 10.2 æ•ˆèƒ½ç›£æ§

```python
import logging

logger = logging.getLogger(__name__)

@log_execution_time
def search_restaurants(...):
    start = time.time()
    result = ...
    logger.info(f"Search took {time.time() - start:.2f}s")
    return result
```

### 10.3 éŒ¯èª¤è¿½è¹¤

```python
try:
    result = handle_search(...)
except Exception as e:
    logger.error(f"Search failed: {e}", exc_info=True)
    # ç™¼é€åˆ°éŒ¯èª¤è¿½è¹¤æœå‹™ (e.g., Sentry)
    raise
```

---

## ç¸½çµ

æ­¤å¢å¼·æœå°‹ç³»çµ±æä¾›ï¼š

âœ… **ä½¿ç”¨è€…é«”é©—**
- å³æ™‚æœå°‹å»ºè­° (< 300ms)
- é€²éšç¯©é¸å™¨ (6+ ç¯©é¸æ¢ä»¶)
- è¦–è¦ºåŒ–ç¯©é¸æ¨™ç±¤
- æœå°‹æ­·å²å¿«é€Ÿé‡æ’­
- ç†±é–€æœå°‹æ¨è–¦

âœ… **æŠ€è¡“ç‰¹æ€§**
- Pattern Matching Callbacks
- Debouncing é˜²æŠ–å‹•
- å¤šå±¤ç´šè³‡æ–™æŒä¹…åŒ–
- éŸ¿æ‡‰å¼è¨­è¨ˆ
- ç„¡éšœç¤™æ”¯æ´

âœ… **å¯æ“´å±•æ€§**
- æ¨¡çµ„åŒ–è¨­è¨ˆ
- æ’ä»¶åŒ–ç¯©é¸å™¨
- å¤šèªè¨€æ”¯æ´
- è‡ªè¨‚æ’åºæ¼”ç®—æ³•

âœ… **æ•ˆèƒ½èˆ‡å®‰å…¨**
- çµæœå¿«å–
- è¼¸å…¥é©—è­‰
- XSS/SQL æ³¨å…¥é˜²è­·
- éŒ¯èª¤è™•ç†èˆ‡å®¹éŒ¯

---

**æ–‡ä»¶ç‰ˆæœ¬**: 1.0.0
**æœ€å¾Œæ›´æ–°**: 2025-11-05
**ç¶­è­·è€…**: Claude (Anthropic)
